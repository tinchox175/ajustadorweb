<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-gl-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-2.4.2.min.js"></script>
    <title>Bokeh Example</title>
    <py-env>
    - bokeh
    - pandas
    - scipy
    </py-env>
  </head>
  <body>
    <p>Visualizador y espremos que graficador de funciones.</p>
    <br />
    <label for="myfile">Eleg√≠ tu archivo (si tiene mas de dos columnas no vas a poder ajustar):</label>
    <input type="file" id="myfile" name="myfile">
    <br />
    <br />
    <div id="print_output"></div>
    <br />
    <p>File Content:</p>
      <div id="content">
      </div>
    </div>
    <div id="plot"></div>
    <button id="yo">yo</button>
    <input type="text" id="funcionajusta" name="funcionajusta">
    <button id="btn">Clear div contents</button>
    <script>
    const container = document.getElementById('plot');
    
    const btn = document.getElementById('btn');
    
    btn.addEventListener('click', function handleClick() {
      container.replaceChildren();
    });
    const graficoold = document.getElementById('plot');
    
    const regraficar = document.getElementById('yo');
    
    regraficar.addEventListener('click', function handleClick() {
      graficoold.replaceChildren();
    });
    </script>
<input type="text" id="par1" name="par1">
<input type="text" id="par2" name="par2">
<input type="text" id="par3" name="par3">
<input type="text" id="par4" name="par4">
<input type="text" id="par5" name="par5">
<py-script>
import json
import asyncio
from js import document, FileReader, console, JSON, Bokeh
from pyodide import create_proxy
import numpy as np
from bokeh.embed import json_item
from bokeh.plotting import figure
from bokeh.resources import CDN
from scipy.optimize import curve_fit

async def process_file(event):
      fileList = event.target.files.to_py()
      for f in fileList:
        data = await f.text()
        lista = data.split("\r\n")
        for i in range(len(lista)):
          lista[i-1] = lista[i-1].split(',')
        data = np.transpose(lista)
        data = np.concatenate(data)
        global data1
        data1 = []
        global data2
        data2 = []
        i = 0
        while i*2<(len(data)):
          if data[i*2]=='':
            break
          data1.append(data[i*2])
          i+=1 
        i = 0
        while i*2<(len(data)):
          try:
            data2.append(data[i*2+1])
          except IndexError:
            pass
          i+=1
        data1 = np.array(data1, dtype=np.float32)
        data2 = np.array(data2, dtype=np.float32)
        global data3
        data3 = [data1,data2]
        p = figure(plot_width=400, plot_height=400)
        p.circle(data1, data2)
        p_json = json.dumps(json_item(p))
        Bokeh.embed.embed_item(JSON.parse(p_json), "plot")
        document.getElementById("content").innerHTML = data3


file_event = create_proxy(process_file)
 
e = document.getElementById("myfile")
e.addEventListener("change", file_event, False)

async def guarda(event):
  global funcionajustadora
  funcionajustadora = Element('funcionajusta').element.value

guardar = create_proxy(guarda)

a = document.getElementById("funcionajusta")
a.addEventListener("input", guardar, False)

async def guarda(event):
  global p1
  p1 = Element('par1').element.value
guardar = create_proxy(guarda)
par1 = document.getElementById("par1")
par1.addEventListener("input", guardar, False)

async def guarda(event):
  global p2
  p2 = Element('par2').element.value
guardar = create_proxy(guarda)
par2 = document.getElementById("par2")
par2.addEventListener("input", guardar, False)

async def guarda(event):
  global p3
  p3 = Element('par3').element.value
guardar = create_proxy(guarda)
par3 = document.getElementById("par3")
par3.addEventListener("input", guardar, False)

async def guarda(event):
  global p4
  p4 = Element('par4').element.value
guardar = create_proxy(guarda)
par4 = document.getElementById("par4")
par4.addEventListener("input", guardar, False)

async def guarda(event):
  global p5
  p5 = Element('par5').element.value
guardar = create_proxy(guarda)
par5 = document.getElementById("par5")
par5.addEventListener("input", guardar, False)






def ajuste(x,a,b,c,d,e):
  y = eval(funcionajustadora)
  return y

async def nib(event):
  print(data1,data2)
  global popt
  popt, pcov = curve_fit(ajuste, data1, data2)
  p = figure(plot_width=400, plot_height=400)
  p.line(data1, ajuste(data1, *popt))
  p.circle(data1, data2)
  p_json = json.dumps(json_item(p))
  Bokeh.embed.embed_item(JSON.parse(p_json), "plot")
  document.getElementById("content").innerHTML = popt,np.sqrt(np.diag(pcov))

you = create_proxy(nib)

b = document.getElementById("yo")
b.addEventListener("click", you, False)

</py-script>


</body>
</html>